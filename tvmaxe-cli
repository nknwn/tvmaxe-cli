#!/usr/bin/env bash
#culori
negru='\E[1;30;40m' rosu='\e[1;31;40m' verde='\e[1;32;40m' galben='\e[1;33;40m' albastru='\e[1;34;40m' purpuriu='\e[1;35;40m' cyan='\e[1;36;40m' alb='\e[1;37;40m' esc='\e[0m'
while :;do
while :;do
clear
echo -e $purpuriu "_____  _   _  _   _    _    _   _  ___ ";echo  ")__ __(\ ( ) /) \_/ (  )_\  ) ( ) () __("
echo  "  | |   )\_/( |  _  | /( )\  ) | ( | _) ";echo  "  )_(    \_/  )_( )_()_/ \_()_( )_()___(";echo;echo "              ___  __    ____ ";echo "             / __)(  )  (_  _)";echo "            ( (__  )(__  _)(_ ";echo "             \___)(____)(____)"
echo v.0.3.7
testconnection=`wget --tries=3 --timeout=15 www.google.com -qO - &>/dev/null 2>&1`
if [ $? != 0 ]; then for i in `seq 1 2`;do 
clear;sleep 1;echo -e $rosu "! Verificati conexiunea la internet !"$esc;sleep 1;done; exit 1;
else
if [ -a $HOME/.commit_tv ]; then
commit1=`wget -qO - https://github.com/nknwn/tvmaxe-cli|grep '"sha"'|sed 's/ /_/g;s/[><]/ /g'|awk '{print $5}'`
commit2=`cat $HOME/.commit_tv|sed -n '$p'`
if [[ "$commit1" != "$commit2" ]]; then 
rm $HOME/.commit_tv 
echo -e $rosu"Actualizare: "$cyan http://nknwn.github.com/tvmaxe-cli/ $rosu
echo -e Pentru a actuaiza doar tvmaxe-cli alegeti '"a"'
echo -e Pentru a actualiza si subscrierele alegeti '"as"'
echo -e Atentie! actualizarea '"as"' presupune suprascrierea fisierului '"~/subscrieri"$purpuriu';fi;
else
wget -qO - https://github.com/nknwn/tvmaxe-cli|grep '"sha"'|sed 's/ /_/g;s/[><]/ /g'|awk '{print $5}' >> $HOME/.commit_tv
fi;
cat $HOME/.subscrieri|sed -n '$p'|sed 's/||/\n /g'|awk '{print $1}'|nl|column -c 30|column -t|more
echo -e $cyan"Alegeti numarul subscrierii dorite:" $cyan "sau parasiti " $rosu"q"$cyan"uit"$rosu
read sursa
if [[ "$sursa" = "q" ]];then exit 0; fi;
if [[ "$sursa" = "a" ]];then 
su -c 'wget -qO - https://raw.github.com/nknwn/tvmaxe-cli/master/tvmaxe-cli > /usr/bin/tvmaxe-cli';exit 0;fi;
if [[ "$sursa" = "as" ]];then
wget -qO - https://raw.github.com/nknwn/tvmaxe-cli/master/.subscrieri > $HOME/.subscrieri
su -c 'wget -qO - https://raw.github.com/nknwn/tvmaxe-cli/master/tvmaxe-cli > /usr/bin/tvmaxe-cli';exit 0;fi;
sur=`cat $HOME/.subscrieri|sed -n '$p'|sed 's/||/\n /g'|awk '{print $2}'|sed -n "${sursa}p"`
if [[ "$sur" = "filme" ]];then
while :;do 
while :;do
clear
echo -e $purpuriu Filme si seriale noi: www.990.ro$verde
wget -qO - http://www.990.ro|sed -n '/border:1/,/clear:/ p'|grep title|sed 's/<[^>]*>/ /g;s/^[ \t]*//;s/[ \t]*$//'|nl
echo -e $purpuriu Selectati numarul filmului dorit sau $rosu"c"$purpuriu"autati" altul";" $rosu"r"$purpuriu"eveniti"";"$rosu "q"$purpuriu"uit"$rosu
read noutate
if [[ "$noutate" = "r" ]]; then break 3;fi;
if [[ "$noutate" = "q" ]]; then exit 0;fi;
###############################################################
if [[ "$noutate" = *$NUMBER* ]];then
adresa=`wget -qO - http://www.990.ro|sed -n '/border:1/,/clear:/ p'|grep title|sed 's/ /_/g;s/"/ /g'|awk '{print $2}'|sed -n "${noutate}p"`
server1=`wget -qO - http://www.990.ro/$adresa|grep Fastupload|sed "s/ /_/g;s/'/ /g"|awk '{print $2}'|sed 's/:/ /g'|awk '{print "http:"$3'}`
server2=`wget -qO - http://www.990.ro/$adresa|grep 180upload|sed "s/ /_/g;s/'/ /g"|awk '{print $2}'|sed 's/:/ /g'|awk '{print "http:"$3'}`
nume=`wget -qO - http://www.990.ro|sed -n '/border:1/,/clear:/ p'|grep title|sed 's/<[^>]*>/ /g;s/^[ \t]*//;s/[ \t]*$//;s/ /_/g'|sed -n "${noutate}p"`
descriere=`wget -qO - http://www.990.ro/$adresa|sed -n "/colspan='2'/,/\/blockquote/ p"|sed 's/<[^>]*>/ /g'`
fi;echo -e $verde
###############################################################
if [[ "$noutate" = "c" ]]; then read -p "Ce film cautam? " titlu
wget -qO - "http://www.990.ro/cauta2.php?text=$titlu&submit=Cauta"|sed -n '/content_wrapper/,/post_title/ p'|grep titlu|sed 's/<[^>]*>/ /g;s/^[\t]*//'|nl|more
filme=`wget -qO - "http://www.990.ro/cauta2.php?text=$titlu&submit=Cauta"|sed -n '/content_wrapper/,/post_title/ p'|grep titlu`
if [[ -z $filme ]]; then clear
for i in `seq 1 2`;do
sleep 1;echo -e $rosu"Nu am gasit filmul cautat sau posibil sa fi gresit denumirea? mai incercati..." 
sleep 1;clear;done;break;fi;
echo -e $purpuriu Selectati numarul filmului dorit sau $rosu"c"$purpuriu"autati" altul";" $rosu"r"$purpuriu"eveniti"";"$rosu "q"$purpuriu"uit"$verde

read numar
if [[ "$numar" = "r" ]];then break 3;fi;
if [[ "$numar" = "c" ]];then break;fi;
if [[ "$numar" = "q" ]];then exit 0;fi;
adresa2=`wget -qO - "http://www.990.ro/cauta2.php?text=$titlu&submit=Cauta"|sed -n '/content_wrapper/,/post_title/ p'|grep jpg|sed 's/ /_/g;s/"/ /g'|awk '{print $2}'|sed 's/_//'|sed -n "${numar}p"`
selectie=`echo $adresa2|sed 's/-/ /'|awk '{print $1}'`
if [[ "$selectie" = "filme" ]]; then
server1=`wget -qO - http://www.990.ro/$adresa2|grep Fastupload|sed "s/ /_/g;s/'/ /g"|awk '{print $2}'|sed 's/:/ /g'|awk '{print "http:"$3'}`
server2=`wget -qO - http://www.990.ro/$adresa2|grep 180upload|sed "s/ /_/g;s/'/ /g"|awk '{print $2}'|sed 's/:/ /g'|awk '{print "http:"$3'}`
nume=`wget -qO - "http://www.990.ro/cauta2.php?text=$titlu&submit=Cauta"|sed -n '/content_wrapper/,/post_title/ p'|grep titlu|sed 's/<[^>]*>/ /g;s/^[\t]*//;s/ /_/g;s/__//g'|sed -n "${numar}p"`
descriere=`wget -qO - http://www.990.ro/$adresa2|sed -n "/colspan='2'/,/\/blockquote/ p"|sed 's/<[^>]*>/ /g'`
#################################################################
else
wget -qO - http://www.990.ro/$adresa2|sed -n '/show_faces/,/show_faces/ p'|sed "s/'/\n /g"|sed 's/<[^>]*>/ /g;s/>/\n/;s/ /_/g;s/</ /'|grep vizionari|awk '{print $1}'|sed 's/_/ /g'|nl|more
echo -e $purpuriu Selectati numarul filmului dorit sau $rosu"c"$purpuriu"autati" altul";" $rosu"r"$purpuriu"eveniti"";"$rosu "q"$purpuriu"uit"$verde
read nr
if [[ "$nr" = "r" ]];then break 3;fi;
if [[ "$nr" = "c" ]];then break;fi;
if [[ "$nr" = "q" ]];then exit 0;fi;
sezoane=`wget -qO - http://www.990.ro/$adresa2|sed -n '/show_faces/,/show_faces/ p'|sed "s/,/\n /g;s/ /_/g;s/'/ /g"|grep href|awk '{print $2}'|sed -n "${nr}p"`
nume=`wget -qO - http://www.990.ro/$adresa2|sed -n '/show_faces/,/show_faces/ p'|sed "s/'/\n /g"|sed 's/<[^>]*>/ /g;s/>/\n/;s/ /_/g;s/</ /;s/__//g'|grep vizionari|awk '{print $1}'|sed -n "${nr}p"`
descriere=`wget -qO - http://www.990.ro/$adresa2|sed -n "/colspan='2'/,/\/blockquote/ p"|sed 's/<[^>]*>/ /g'`
server1=`wget -qO - http://www.990.ro/$sezoane|grep Fastupload|sed "s/ /_/g;s/'/ /g"|awk '{print $2}'|sed 's/:/ /g'|awk '{print "http:"$3'}`
server2=`wget -qO - http://www.990.ro/$sezoane|grep 180upload|sed "s/ /_/g;s/'/ /g"|awk '{print $2}'|sed 's/:/ /g'|awk '{print "http:"$3'}`
fi;fi;
#################################################################
fast=`wget -qO - $server1|grep fastupload|sed "s/ /_/g;s/'/ /g"|awk '{print $2}'`
upload=`wget -qO - $server2|grep 180upload|sed 's/ /_/g;s/"/ /g'|awk '{print $2}'`
film1=`wget -qO - $fast|grep flv|sed "s/ /_/;s/'/ /g"|awk '{print $4}'`
film2=`wget -qO - $upload|grep "video|"|sed 's/ /_/g;s/|/ /g'|awk '{print "http://"$10"."$9"."$8"."$7":"$20"/d/"$19"/video.flv"}'`
################################################################
echo -e $verde$descriere
consola=`echo $DISPLAY'a'`
if [[ "$consola" = "a" ]]; then
echo -e $purpuriu Introduceti marimea ferestrei si coordonatele de redare $rosu "(ex. 360 10:10)" 
read marime coordonate
else
marime=360
coordonate=10:20
fi;
################################################################
echo -e $purpuriu
OPTIUNE="Redati Descarcati Inregistrati Cautati Reveniti Parasiti"
select opt in $OPTIUNE;do
if [[ "$opt" = "Redati" ]]; then mplayer -cache 1000 -hardframedrop -cache-min 20 -msglevel cache=-1 -prefer-ipv4 -msgcolor -nolirc -ao alsa -vo xv,fbdev2, -xy $marime -zoom -geometry $coordonate -nobps -ni -forceidx -mc 0 $film1||mplayer -cache 1000 -hardframedrop -cache-min 20 -msglevel cache=-1 -prefer-ipv4 -msgcolor -nolirc -ao alsa -vo xv,fbdev2, -xy $marime -zoom -geometry $coordonate -nobps -ni -forceidx -mc 0 $film2 ; break
elif [[ "$opt" = "Descarcati" ]]; then axel -a -o $nume.flv $film1||axel -a -o $nume.flv $film2||wget -O $nume.flv $film1||wget -O $nume.flv $film2 ; break
elif [[ "$opt" = "Cautati" ]];then clear; break;
elif [[ "$opt" = "Reveniti" ]];then break 4;
elif [[ "$opt" = "Inregistrati" ]]; then (wget -O $HOME/$nume.flv $film1||wget -O $HOME/$nume.flv $film2 &> /dev/null &); echo -e $rosu "redarea va incepe in 10 sec" $purpuriu; sleep 10 ; wait $(mplayer -cache 1000 -hardframedrop -cache-min 20 -msglevel cache=-1 -prefer-ipv4 -msgcolor -nolirc -ao alsa -vo xv,fbdev2, -xy $marime -zoom -geometry $coordonate  -osdlevel 2 $HOME/$nume.flv||mplayer -cache 1000 -hardframedrop -cache-min 20 -msglevel cache=-1 -prefer-ipv4 -msgcolor -nolirc -ao alsa -vo xv,fbdev2, -xy $marime -zoom -geometry $coordonate  -osdlevel 2 $HOME/$nume.flv); killall wget;
echo -e $cyan Doriti sa pastrati inregistrarea $verde "y"$cyan"/"$rosu"n"$cyan"?"
read rec
if  [[ "$rec" = "n" ]]; then rm $HOME/$nume.flv; exit 0;else break 4;fi;
elif [[ "$opt" = "Parasiti" ]]; then exit 0;
else echo -e $rosu Ati ales gresit, mai incercati. $esc
fi;done;done;done;fi
#########################################################
consola=`echo $DISPLAY'a'`
echo -e $verde "Lista canale:"
if [[ "$consola" = "a" ]];then 
if [[ "$sur" = "cooltv" ]];then
wget -qO - http://www.cool-tv.ro/m/|grep sop|sed 's/ /_/g;s/"/ /g;s/.gif//'|awk '{print $4}'|sed 's/^...//;$d;s/-/_/g'|nl|column -c 30|column -t|more
else
wget -qO - $sur|sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $2}'|nl|column -c 30|column -t|sed 's/â/a/g;s/ă/a/g;s/ț/t/g;s/ș/s/g;s/î/i/g'
fi;
echo -e $rosu "Introduceti marimea ferestrei de redare si coordonatele acesteia (ex. 360 10:10) "
echo -e $rosu "in caz ca acesta este un post radio alegeti orice valoare..."
read marime coordonate
else
marime=360
coordonate=10:20
if [[ "$sur" = "cooltv" ]];then
wget -qO - http://www.cool-tv.ro/m/|grep sop|sed 's/ /_/g;s/"/ /g;s/.gif//'|awk '{print $4}'|sed 's/^...//;$d;s/-/_/g'|nl|column -c 30|column -t|more
else
wget -qO - $sur|sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $2}'|nl|column -c 30|column -t|more
fi;fi;
echo -e $purpuriu Selectati numarul postului dorit sau $rosu"r"$purpuriu"eveniti"";"$rosu "q"$purpuriu"uit" $rosu"i"$purpuriu"nregistrati"$rosu
read canal
if [[ "$canal" = "r" ]]; then break;fi;
if [[ "$canal" = "q" ]]; then clear ; exit 0; fi;
if [[ "$canal" = "i" ]]; then echo "Alegeti postul dorit pentru inregistrare:"
read canal2
clear
echo inregistrez... 
echo La inregistrarea adreselor sop pot aparea erori,
echo insa daca programul nu se intrerupe, asteptati un pic...
if [[ "$sur" = "cooltv" ]];then
adr2=`wget -qO - http://www.cool-tv.ro/m/|grep sop|sed 's/ /_/g;s/"/ /g;s/.gif//;$d'|awk '{print $2}'|sed -n "${canal2}p"`
numetv=`wget -qO - http://www.cool-tv.ro/m/|grep sop|sed 's/ /_/g;s/"/ /g;s/.gif//'|awk '{print $4}'|sed 's/^...//;$d;s/-/_/g'|sed -n "${canal2}p"`
else
adr2=`wget -qO - $sur | sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $4}'|sed -n "${canal2}p"`
numetv=`wget -qO - $sur | sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $2}'|sed -n "${canal2}p"`
fi;
data=`date +_%F_%H-%M-%S`
soptest2=`wget -qO - $sur | sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $4}'|sed -n "${canal2}p"|sed 's/:/ /g'|awk '{print $1}'`
pls2=`wget -qO - $sur | sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $4}'|sed -n "${canal2}p"|sed 's/\./ /g'|awk '{ print $NF }'`
echo $numetv
if [[ "$pls2" = "pls" ]]||[[ "$pls2" = "m3u" ]]; then list="-playlist";else list=" ";fi;
if [[ "$soptest2" = "sop" ]]; then 
$(sp-sc $adr2 8901 9901 &>/dev/null &); sleep 20; wait $(mplayer http://localhost:9901 -dumpstream -dumpfile $HOME/$numetv$data.mp4 &); $(mplayer -osdlevel 2 $HOME/$numetv$data.mp4); killall sp-sc mplayer;break 4;
#$(sp-sc $adr2 8901 9901 &>/dev/null &); sleep 10; wait $(wget -O $HOME/$numetv$data.mp4  http://localhost:9901 &>/dev/null &);sleep 5; $(mplayer -osdlevel 2 $HOME$numetv$data.mp4 );killall sp-sc wget;
else
$(mplayer $list $adr2  -dumpstream -dumpfile $HOME/$numetv$data.mp4 &>/dev/null & ); sleep 10 ; wait $(mplayer -msgcolor -nolirc -ao alsa -vo xv,fbdev2, -xy $marime -zoom -geometry $coordonate -osdlevel 2 $HOME/$numetv$data.mp4); killall mplayer; break 4;
fi;fi;
############################
if [[ "$canal" = *$NUMBER* ]];then clear
if [[ "$sur" = "cooltv" ]];then
adr=`wget -qO - http://www.cool-tv.ro/m/|grep sop|sed 's/ /_/g;s/"/ /g;s/.gif//;$d'|awk '{print $2}'|sed -n "${canal}p"`
soptest=`wget -qO - http://www.cool-tv.ro/m/|grep sop|sed 's/ /_/g;s/"/ /g;s/.gif//;$d'|awk '{print $2}'|sed -n "${canal}p"|sed 's/:/ /g'|awk '{print $1}'`
else
adr=`wget -qO - $sur | sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $4}'|sed -n "${canal}p"`
soptest=`wget -qO - $sur | sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $4}'|sed -n "${canal}p"|sed 's/:/ /g'|awk '{print $1}'`
pls=`wget -qO - $sur | sed 's/||/\n /g;s/ /_/g;s/|/ /g'|sed '1d'|awk '{print $4}'|sed -n "${canal}p"|sed 's/\./ /g'|awk '{ print $NF }'`
fi;
if [[ "$pls" = "pls" ]]||[[ "$pls" = "m3u" ]]; then list="-playlist";else list=" ";fi;
echo -e $verde "procesez..."
if [[ "$soptest" = "sop" ]]; then 
$(sp-sc $adr 8901 9901 &>/dev/null &); sleep 10; wait $(mplayer -cache 500 -cache-min 20 -msglevel all=-1 -prefer-ipv4 -msgcolor -nolirc -ao alsa -vo xv,fbdev2, -xy $marime -zoom -geometry $coordonate http://localhost:9901); killall sp-sc
else
mplayer -hardframedrop -cache 500 -cache-min 20 -msglevel cache=-1 -prefer-ipv4 -msgcolor -nolirc -ao alsa -vo xv,fbdev2, -xy $marime -zoom -geometry  $coordonate $list $adr
fi;fi;
#############################
fi;done;done


